<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worship Lyrics Slideshow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .blur-text {
            filter: blur(1px);
            opacity: 0.8;
        }
        
        .dark .app-container {
            background-color: #181818;
            color: white;
        }
        
        .dark .input-container {
            background-color: #222;
        }
        
        .dark .slideshow-container {
            background-color: #111;
        }
        
        .transition-all {
            transition: all 0.3s ease;
        }
        
        /* Simple, clean transitions */
        .lyrics-line {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="h-full m-0 font-sans bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="app-container h-full flex flex-col">
        <!-- Input view -->
        <div id="inputView" class="flex flex-col h-full p-4">
            <h1 class="text-2xl font-bold text-center mb-4 text-primary dark:text-primary">Worship Lyrics Slideshow</h1>
            
            <div class="input-container bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex-grow flex flex-col">
                <label for="lyricsInput" class="block text-sm font-medium mb-2">Paste your lyrics below:</label>
                <textarea 
                    id="lyricsInput" 
                    class="w-full flex-grow p-3 border rounded-md text-base dark:bg-gray-700 dark:border-gray-600 focus:border-primary focus:ring-primary"
                    placeholder="Enter your lyrics here. Each line will be treated as a separate slide."></textarea>
                
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button 
                        id="startButton" 
                        class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-md text-base transition-all"
                        >Start Slideshow</button>
                    <button 
                        id="saveButton" 
                        class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-md text-base transition-all"
                        >Save to File</button>
                    <button 
                        id="loadButton" 
                        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-md text-base transition-all"
                        >Load from File</button>
                    <button 
                        id="clearButton" 
                        class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 py-2 px-6 rounded-md text-base transition-all"
                        >Clear Lyrics</button>
                    <input type="file" id="fileInput" accept=".txt" class="hidden" />
                </div>
            </div>
        </div>
        
        <!-- Slideshow view -->
        <div id="slideshowView" class="h-full flex flex-col hidden">
            <div class="slideshow-container bg-black text-white flex-grow flex flex-col justify-center items-center relative" id="slideshowContainer">
                <div class="absolute top-4 left-4 flex space-x-2">
                    <button 
                        id="exitButton" 
                        class="bg-gray-800 hover:bg-gray-700 text-white py-1 px-3 rounded-md text-sm"
                        >Exit</button>
                    <button 
                        id="prevButton" 
                        class="bg-gray-800 hover:bg-gray-700 text-white py-1 px-3 rounded-md text-sm"
                        title="Go to previous slide"
                        >&larr; Back</button>
                </div>
                
                <div id="instructionText" class="text-center p-8 animate-fade-in">
                    <p class="text-xl mb-4">Click anywhere to advance through the lyrics</p>
                    <p class="text-gray-400">Current slide is shown in full, next slide is blurred</p>
                </div>
                
                <div id="lyricsDisplay" class="text-center p-8 hidden overflow-hidden">
                    <!-- Current lyrics (2 lines) -->
                    <div class="mb-8 lyrics-container slide-in-active">
                        <div id="currentLyric1" class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4 min-h-[3rem] lyrics-line"></div>
                        <div id="currentLyric2" class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4 min-h-[3rem] lyrics-line"></div>
                    </div>
                    
                    <!-- Next lyrics (2 lines, less blurred) -->
                    <div class="blur-text lyrics-container slide-in-active">
                        <div id="nextLyric1" class="text-xl md:text-2xl mb-2 min-h-[2rem] lyrics-line"></div>
                        <div id="nextLyric2" class="text-xl md:text-2xl mb-2 min-h-[2rem] lyrics-line"></div>
                    </div>
                </div>
                
                <div class="absolute bottom-4 w-full flex justify-between px-6">
                    <div id="slideInfo" class="text-gray-400"></div>
                    <div class="text-gray-400">Tap/click to advance</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode based on user preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Get DOM elements
        const inputView = document.getElementById('inputView');
        const slideshowView = document.getElementById('slideshowView');
        const lyricsInput = document.getElementById('lyricsInput');
        const startButton = document.getElementById('startButton');
        const clearButton = document.getElementById('clearButton');
        const exitButton = document.getElementById('exitButton');
        const slideshowContainer = document.getElementById('slideshowContainer');
        const instructionText = document.getElementById('instructionText');
        const lyricsDisplay = document.getElementById('lyricsDisplay');
        const currentLyric1 = document.getElementById('currentLyric1');
        const currentLyric2 = document.getElementById('currentLyric2');
        const nextLyric1 = document.getElementById('nextLyric1');
        const nextLyric2 = document.getElementById('nextLyric2');
        const slideInfo = document.getElementById('slideInfo');
        
        let lyrics = [];
        let currentIndex = 0;
        
        // Event Listeners
        startButton.addEventListener('click', startSlideshow);
        clearButton.addEventListener('click', clearLyrics);
        exitButton.addEventListener('click', exitSlideshow);
        slideshowContainer.addEventListener('click', advanceSlide);
        
        // Get the previous button and add its event listener
        const prevButton = document.getElementById('prevButton');
        prevButton.addEventListener('click', goToPreviousSlide);
        
        // Get file handling elements and add event listeners
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const fileInput = document.getElementById('fileInput');
        
        saveButton.addEventListener('click', saveToFile);
        loadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', loadFromFile);
        
        // Try to load saved lyrics from localStorage if available
        try {
            const savedLyrics = localStorage.getItem('worshipLyrics');
            if (savedLyrics) {
                lyricsInput.value = savedLyrics;
            }
        } catch (e) {
            console.log('LocalStorage not available:', e);
        }
        
        function startSlideshow() {
            const text = lyricsInput.value.trim();
            if (!text) {
                alert('Please enter some lyrics first.');
                return;
            }
            
            // Try to save lyrics to localStorage
            try {
                localStorage.setItem('worshipLyrics', text);
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }
            
            // Split into lines and remove empty lines and section headers
            lyrics = text.split('\n')
                .map(line => line.trim())
                .filter(line => {
                    if (line.length === 0) return false;
                    
                    // Skip lines that start with verse, chorus, or bridge (case-insensitive)
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.startsWith('verse') || 
                        lowerLine.startsWith('chorus') || 
                        lowerLine.startsWith('bridge')) {
                        return false;
                    }
                    
                    return true;
                });
            
            if (lyrics.length === 0) {
                alert('Please enter valid lyrics with at least one line.');
                return;
            }
            
            // Switch to slideshow view
            inputView.classList.add('hidden');
            slideshowView.classList.remove('hidden');
            
            // Reset and start slideshow
            currentIndex = 0;
            instructionText.classList.remove('hidden');
            lyricsDisplay.classList.add('hidden');
        }
        
        function advanceSlide() {
            // If first click, hide instructions and show lyrics
            if (!instructionText.classList.contains('hidden')) {
                instructionText.classList.add('hidden');
                lyricsDisplay.classList.remove('hidden');
                updateLyricDisplay();
                return;
            }
            
            // Advance to next slide (by 2 lines for natural flow)
            currentIndex += 2;
            
            // If we've reached the end, go back to start
            if (currentIndex >= lyrics.length) {
                currentIndex = 0;
            }
            
            updateLyricDisplay();
        }
        
        function updateLyricDisplay() {
            // Simple, immediate update - no animations
            currentLyric1.textContent = lyrics[currentIndex] || '';
            currentLyric2.textContent = lyrics[currentIndex + 1] || '';
            nextLyric1.textContent = lyrics[currentIndex + 2] || '';
            nextLyric2.textContent = lyrics[currentIndex + 3] || '';
            
            // Handle wrap-around for preview lines
            if (currentIndex + 2 >= lyrics.length) {
                nextLyric1.textContent = lyrics[(currentIndex + 2) % lyrics.length] || '';
            }
            if (currentIndex + 3 >= lyrics.length) {
                nextLyric2.textContent = lyrics[(currentIndex + 3) % lyrics.length] || '';
            }
            
            // Clean, clear styling
            currentLyric1.style.filter = 'none';
            currentLyric2.style.filter = 'none';
            currentLyric1.style.opacity = '1';
            currentLyric2.style.opacity = '1';
            
            nextLyric1.style.filter = 'blur(0.5px)';
            nextLyric2.style.filter = 'blur(0.5px)';
            nextLyric1.style.opacity = '0.7';
            nextLyric2.style.opacity = '0.7';
            
            // Update slide information
            const totalSlides = lyrics.length;
            const currentSlide = currentIndex + 1;
            slideInfo.textContent = `Line ${currentSlide} of ${totalSlides}`;
        }
        
        function clearLyrics() {
            lyricsInput.value = '';
            try {
                localStorage.removeItem('worshipLyrics');
            } catch (e) {
                console.log('Could not clear localStorage:', e);
            }
        }
        
        function exitSlideshow() {
            slideshowView.classList.add('hidden');
            inputView.classList.remove('hidden');
        }
        
        function goToPreviousSlide(event) {
            // Stop event propagation to prevent the main click handler from firing
            event.stopPropagation();
            
            // If we're still showing the instruction text, do nothing
            if (!instructionText.classList.contains('hidden')) {
                return;
            }
            
            // Go to the previous slide (by 2 lines for natural flow)
            currentIndex -= 2;
            
            // If we're before the first slide, loop to the end
            if (currentIndex < 0) {
                // Find the last valid 2-line starting position
                const totalSlides = Math.ceil(lyrics.length / 2);
                currentIndex = (totalSlides - 1) * 2;
            }
            
            updateLyricDisplay();
        }
        
        // Function to save the current lyrics to a text file
        function saveToFile() {
            const text = lyricsInput.value.trim();
            if (!text) {
                alert('Please enter some lyrics first before saving.');
                return;
            }
            
            // Create an invisible link element
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a link to download the file
            const a = document.createElement('a');
            a.href = url;
            
            // Get song title from first non-empty line or use default
            let firstLine = text.split('\n').find(line => line.trim().length > 0) || '';
            // Clean up the title: remove section markers and limit length
            firstLine = firstLine.replace(/^(verse|chorus|bridge)\s*\d*/i, '').trim();
            const fileName = firstLine.slice(0, 30).trim() || 'worship-lyrics';
            
            a.download = `${fileName}.txt`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saved!';
            setTimeout(() => {
                saveButton.textContent = originalText;
            }, 1500);
        }
        
        // Function to load lyrics from a text file
        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                lyricsInput.value = e.target.result;
                
                // Save to localStorage
                try {
                    localStorage.setItem('worshipLyrics', e.target.result);
                } catch (err) {
                    console.log('Could not save to localStorage:', err);
                }
                
                // Show success message
                const originalText = loadButton.textContent;
                loadButton.textContent = 'Loaded!';
                setTimeout(() => {
                    loadButton.textContent = originalText;
                }, 1500);
            };
            
            reader.readAsText(file);
            
            // Reset the file input so the same file can be loaded again
            fileInput.value = '';
        }
    </script>
</body>
</html>
